name: Post-Release Preparation

on:
  workflow_call:
    inputs:
      REPO_URL:
        description: '<github-account-name>/<repo-name>'
        required: true
        type: string
      REPO_BRANCH:
        required: true
        type: string
      BASE:
        description: 'base branch for PR'
        required: true
        type: string
      UPDATE_RELEASE_URL:
        description: 'Set to true to update Maven publish URL to RELEASE_URL'
        required: false
        type: boolean
        default: false
      UPDATE_SNAPSHOT_URL:
        description: 'Set to true to update Maven publish URL to OSSRH_SNAPSHOT_URL'
        required: false
        type: boolean
        default: false
    secrets:
      SLACK_WEBHOOK_URL:
        required: true
      ACTION_PAT:
        required: true

jobs:
  maven-post-release-preparation:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          repository: ${{ inputs.REPO_URL }}
          ref: ${{ inputs.REPO_BRANCH }}
      - name: Setup branch and env
        run: |
          # Strip git ref prefix from version
          echo "BRANCH_NAME=$(echo ${{ github.ref }} | sed -e 's,.*/\(.*\),\1,')" >> $GITHUB_ENV
          echo "GPG_TTY=$(tty)" >> $GITHUB_ENV

      - name: Conditional Maven URL Update
        run: |
          cd .github/workflows
          if [ "${{ inputs.UPDATE_RELEASE_URL }}" = "true" ]; then
            sed -i 's/OSSRH_SNAPSHOT_URL/RELEASE_URL/g' *push-trigger.yml
          elif [ "${{ inputs.UPDATE_SNAPSHOT_URL }}" = "true" ]; then
            sed -i 's/RELEASE_URL/OSSRH_SNAPSHOT_URL/g' *push-trigger.yml
          fi

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5.0.2
        with:
          commit-message: Updated Pom versions for release changes
          title: Post release changes
          branch: release-branch
          delete-branch: true
          base: ${{ inputs.BASE }}
          token: ${{ secrets.ACTION_PAT }}
          signoff: true

      - uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: repo,message,author,commit,workflow,job # selectable (default: repo,message)
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }} # required
        if: failure() # Pick up events even if the job fails or is canceled.